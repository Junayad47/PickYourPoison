<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Christmas Hazard</title>
    
    <!-- 
      This game's HTML and JavaScript.
      All styles are in the external 'style.css' file.
    -->
    
    <!-- Link to the external stylesheet -->
    <link rel="stylesheet" href="style.css">
    
</head>
<body>

    <div id="snow-container"></div>

    <div id="game-container">
        
        <div id="snowman">â›„</div>

        <!-- ===== MODE SELECT SCREEN ===== -->
        <div id="mode-select-screen" class="screen active">
            <h1>Christmas Hazard</h1>
            <h3 style="text-align: center; margin-bottom: 20px;">Santa vs. Grinch</h3>
            <p>How do you want to play?</p>
            <button id="play-offline-btn" class="game-button">Play Offline (Hot-Seat)</button>
            <button id="play-online-btn" class="game-button secondary">Play Online (2 Devices)</button>
        </div>
        
        <!-- ===== ONLINE SETUP SCREEN ===== -->
        <div id="online-setup-screen" class="screen">
            <h2>Play Online</h2>
            <button id="host-game-btn" class="game-button">Host New Game</button>
            <div class="input-group" style="margin-top: 20px;">
                <label for="join-game-id">Or Join Game:</label>
                <input type="text" id="join-game-id" placeholder="Enter 6-Digit ID" maxlength="6" pattern="\d*">
            </div>
            <button id="join-game-btn" class="game-button secondary">Join Game</button>
            <button id="back-to-mode-select-btn" class="game-button" style="background: #555; border-bottom-color: #333; margin-top: 20px;">Back</button>
        </div>
        
        <!-- ===== LOADING SCREEN ===== -->
        <div id="loading-screen" class="screen">
            <h2 id="loading-title">Loading...</h2>
            <div class="loader"></div>
            <p id="loading-message" class="loading-text">Connecting to the North Pole...</p>
            <div id="game-id-display-container" style="display: none;">
                <p>Tell your friend to join with this Game ID:</p>
                <div id="game-id-display">123456</div>
            </div>
        </div>

        <!-- ===== OFFLINE START SCREEN ===== -->
        <div id="start-screen" class="screen">
            <h1>Christmas Hazard</h1>
            <p>Santa's bag has 32 mysterious gifts. But beware! Each of you must secretly pick one gift to fill with COAL.</p>
            <p>Take turns picking gifts. If you pick one with coal, you're on stocking duty! Last one standing wins.</p>
            
            <div class="input-group">
                <label for="player1-name">Player 1 Name:</label>
                <input type="text" id="player1-name" placeholder="Santa" value="Santa">
            </div>
            <div class="input-group">
                <label for="player2-name">Player 2 Name:</label>
                <input type="text" id="player2-name" placeholder="Grinch" value="Grinch">
            </div>
            <button id="start-game-btn" class="game-button">Start the Gifting</button>
        </div>

        <!-- ===== GAME SCREEN ===== -->
        <div id="game-screen" class="screen">
            <div id="status-bar">
                <div id="player-1-status" class="player-status">Player 1</div>
                <div id="turn-indicator">Turn</div>
                <div id="player-2-status" class="player-status">Player 2</div>
            </div>
            
            <div id="message-box">
                Loading gifts...
            </div>
            
            <div id="ornament-grid">
                <!-- Gifts will be generated by JavaScript -->
            </div>
            
        </div>

        <!-- ===== GAME OVER SCREEN ===== -->
        <div id="game-over-screen" class="screen">
            <h2>Stocking Duty!</h2>
            <p id="winner-message">The winner is...</p>
            <button id="play-again-btn" class="game-button">Play Again</button>
        </div>

    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            updateDoc,
            onSnapshot,
            collection,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyB36gEAQwwnDcLI2jONG3mZ-N9ndu-YmIE",
          authDomain: "four-in-a-row-watermelon.firebaseapp.com",
          databaseURL: "https://four-in-a-row-watermelon-default-rtdb.firebaseio.com",
          projectId: "four-in-a-row-watermelon",
          storageBucket: "four-in-a-row-watermelon.firebasestorage.app",
          messagingSenderId: "62983592186",
          appId: "1:62983592186:web:8c1886826e93e2ce9ed143",
          measurementId: "G-XF032WKJRC"
        };

        // Initialize Firebase
        const globalApp = initializeApp(firebaseConfig);
        // const analytics = getAnalytics(globalApp); // Analytics isn't used in this app

        document.addEventListener('DOMContentLoaded', () => {

            // --- Global State ---
            let isOnlineMode = false;
            let db, auth, app, userId, gameId;
            let localGameUnsubscribe = () => {}; // Function to stop listening to Firestore
            
            // --- Local (Offline) State Variables ---
            let local_player1Name = 'Player 1';
            let local_player2Name = 'Player 2';
            let local_player1Poison = -1;
            let local_player2Poison = -1;
            let local_currentPlayer = 1;
            let local_gameState = 'START'; // P1_POISON, P2_POISON_WAIT, P2_POISON, START_TURN_WAIT, P1_TURN, P2_TURN, GAME_OVER
            let local_ornaments = [];
            const TOTAL_ORNAMENTS = 32;

            // --- DOM Elements ---
            const screens = {
                modeSelect: document.getElementById('mode-select-screen'),
                onlineSetup: document.getElementById('online-setup-screen'),
                loading: document.getElementById('loading-screen'),
                start: document.getElementById('start-screen'),
                game: document.getElementById('game-screen'),
                gameOver: document.getElementById('game-over-screen')
            };
            
            const player1NameInput = document.getElementById('player1-name');
            const player2NameInput = document.getElementById('player2-name');
            const startGameBtn = document.getElementById('start-game-btn');
            
            const player1Status = document.getElementById('player-1-status');
            const player2Status = document.getElementById('player-2-status');
            const turnIndicator = document.getElementById('turn-indicator');
            const messageBox = document.getElementById('message-box');
            const grid = document.getElementById('ornament-grid');
            
            const winnerMessage = document.getElementById('winner-message');
            const playAgainBtn = document.getElementById('play-again-btn');
            
            const snowContainer = document.getElementById('snow-container');
            
            // Mode Select Buttons
            const playOfflineBtn = document.getElementById('play-offline-btn');
            const playOnlineBtn = document.getElementById('play-online-btn');
            
            // Online Setup Buttons & Inputs
            const hostGameBtn = document.getElementById('host-game-btn');
            const joinGameIdInput = document.getElementById('join-game-id');
            const joinGameBtn = document.getElementById('join-game-btn');
            const backToModeSelectBtn = document.getElementById('back-to-mode-select-btn');
            
            // Loading Screen Elements
            const loadingTitle = document.getElementById('loading-title');
            const loadingMessage = document.getElementById('loading-message');
            const gameIdDisplayContainer = document.getElementById('game-id-display-container');
            const gameIdDisplay = document.getElementById('game-id-display');

            // --- Utility Functions ---
            
            /**
             * Switches the active screen
             */
            function showScreen(screenName) {
                // Stop any existing game listeners if we're leaving the game screen
                if (isOnlineMode && screenName !== 'game' && screenName !== 'loading') { // Keep listener on loading screen!
                    localGameUnsubscribe();
                }
                
                Object.values(screens).forEach(screen => screen.classList.remove('active'));
                if (screens[screenName]) {
                    screens[screenName].classList.add('active');
                }
            }
            
            /**
             * Creates the falling snow effect
             */
            function createSnow() {
                // Only create snow once
                if (snowContainer.children.length > 0) return;
                
                const flakeCount = 100;
                for (let i = 0; i < flakeCount; i++) {
                    const flake = document.createElement('div');
                    flake.classList.add('flake');
                    
                    const size = Math.random() * 5 + 2; // 2px to 7px
                    flake.style.width = `${size}px`;
                    flake.style.height = `${size}px`;
                    flake.style.left = `${Math.random() * 100}vw`;
                    flake.style.opacity = Math.random() * 0.5 + 0.3; // 0.3 to 0.8
                    const duration = Math.random() * 10 + 10; // 10s to 20s
                    flake.style.animationDuration = `${duration}s`;
                    flake.style.animationDelay = `${Math.random() * -10}s`; // Start at random times
                    
                    const horizontalDrift = `translateX(${Math.random() * 100 - 50}px)`;
                    flake.animate([
                        { transform: `translateY(-10px) ${horizontalDrift}` },
                        { transform: `translateY(105vh) ${horizontalDrift}` }
                    ], {
                        duration: duration * 1000,
                        delay: Math.random() * -10000,
                        iterations: Infinity,
                        easing: 'linear'
                    });
                    snowContainer.appendChild(flake);
                }
            }
            
            /**
             * Resets the entire app to the mode select screen
             */
            function fullReset() {
                localGameUnsubscribe(); // Stop listening
                isOnlineMode = false;
                db = null;
                auth = null;
                app = null;
                userId = null;
                gameId = null;
                
                // Reset local game state just in case
                initOfflineGame(); 
                
                // Go back to the very first screen
                showScreen('modeSelect');
            }
            
            // ==============================================
            // === OFFLINE (HOT-SEAT) GAME LOGIC ===========
            // ==============================================

            /**
             * Resets the game to its initial state for OFFLINE play
             */
            function initOfflineGame() {
                local_player1Poison = -1;
                local_player2Poison = -1;
                local_currentPlayer = 1;
                local_gameState = 'START';
                local_ornaments = [];
                
                grid.innerHTML = '';
                player1NameInput.value = 'Santa';
                player2NameInput.value = 'Grinch';
                
                showScreen('start');
            }

            /**
             * Starts the OFFLINE game
             */
            function startOfflineGame() {
                local_player1Name = player1NameInput.value || 'Santa';
                local_player2Name = player2NameInput.value || 'Grinch';

                showScreen('game');
                
                generateOfflineOrnaments();
                setupOfflinePoisonPhase();
            }

            /**
             * Creates and displays all 32 ornament elements for OFFLINE play
             */
            function generateOfflineOrnaments() {
                grid.innerHTML = ''; 
                local_ornaments = []; 
                
                for (let i = 1; i <= TOTAL_ORNAMENTS; i++) {
                    const ornament = createOrnamentElement(i, false); // Not revealed
                    ornament.addEventListener('click', onOrnamentClick);
                    grid.appendChild(ornament);
                    local_ornaments.push({ id: i, isRevealed: false });
                }
            }
            
            /**
             * Creates a single ornament DOM element
             */
            function createOrnamentElement(id, isRevealed, isPoison = false) {
                 const ornament = document.createElement('div');
                ornament.classList.add('ornament');
                ornament.dataset.id = id;
                // Icons are now handled by CSS ::before
                
                if (isRevealed) {
                    ornament.classList.add('revealed');
                    if (isPoison) {
                        ornament.classList.add('poison');
                    }
                }
                return ornament;
            }

            /**
             * Begins the poison selection phase for Player 1 (OFFLINE)
             */
            function setupOfflinePoisonPhase() {
                local_gameState = 'P1_POISON';
                messageBox.textContent = `${local_player1Name}, click a gift to fill with COAL. (Don't let ${local_player2Name} see!)`;
                messageBox.classList.remove('transition');
                updateOfflinePlayerStatus();
                turnIndicator.textContent = 'Naughty Phase';
            }
            
            /**
             * Handles clicks on the message box during OFFLINE transition states
             */
            function handleOfflineTransitionClick() {
                if (local_gameState === 'P2_POISON_WAIT') {
                    local_gameState = 'P2_POISON';
                    messageBox.textContent = `${local_player2Name}, pick YOUR gift to fill with COAL. (Don't let ${local_player1Name} see!)`;
                    messageBox.classList.remove('transition');
                    grid.classList.remove('opponent-picking'); // Stop shivering
                }
                else if (local_gameState === 'START_TURN_WAIT') {
                    local_gameState = 'P1_TURN';
                    local_currentPlayer = 1;
                    messageBox.textContent = `The unwrapping begins! ${local_player1Name}, pick a gift.`;
                    messageBox.classList.remove('transition');
                    grid.classList.remove('opponent-picking'); // Stop shivering
                    updateOfflineTurnIndicator();
                }
            }

            /**
             * Reveals an ornament (OFFLINE)
             */
            function revealOfflineOrnament(id, data, element) {
                data.isRevealed = true;
                element.classList.add('revealed');
                
                const activePlayerName = (local_currentPlayer === 1) ? local_player1Name : local_player2Name;
                
                if (id === local_player1Poison || id === local_player2Poison) {
                    element.classList.add('poison');
                    handleOfflinePoisonHit(activePlayerName);
                } else {
                    messageBox.textContent = 'Nice! Just a lovely gift...';
                    setTimeout(switchOfflineTurn, 1000); // Short delay
                }
            }
            
            /**
             * Handles logic when a poisoned ornament is hit (OFFLINE)
             */
            function handleOfflinePoisonHit(activePlayerName) {
                const winner = (local_currentPlayer === 1) ? local_player2Name : local_player1Name;
                messageBox.textContent = `OH NO! ${activePlayerName} found a lump of coal!`;
                
                setTimeout(() => {
                    endOfflineGame(`${activePlayerName} is on stocking duty! ${winner} gets the sleigh!`);
                }, 2000);
            }

            /**
             * Switches the turn to the other player (OFFLINE)
             */
            function switchOfflineTurn() {
                local_currentPlayer = (local_currentPlayer === 1) ? 2 : 1;
                local_gameState = (local_currentPlayer === 1) ? 'P1_TURN' : 'P2_TURN';
                updateOfflineTurnIndicator();
                messageBox.textContent = `It's your turn, ${local_currentPlayer === 1 ? local_player1Name : local_player2Name}.`;
            }
            
            /**
             * Updates the turn indicator (OFFLINE)
             */
            function updateOfflineTurnIndicator() {
                const activePlayerName = (local_currentPlayer === 1) ? local_player1Name : local_player2Name;
                turnIndicator.textContent = `${activePlayerName}'s Turn`;
                grid.classList.remove('opponent-picking'); // Stop shivering
                
                if (local_currentPlayer === 1) {
                    player1Status.classList.add('active');
                    player2Status.classList.remove('active');
                } else {
                    player1Status.classList.remove('active');
                    player2Status.classList.add('active');
                }
            }

            /**
             * Updates the player status bars (OFFLINE)
             */
            function updateOfflinePlayerStatus() {
                player1Status.innerHTML = `${local_player1Name}`;
                player2Status.innerHTML = `${local_player2Name}`;
            }

            /**
             * Ends the game (OFFLINE)
             */
            function endOfflineGame(message) {
                local_gameState = 'GAME_OVER';
                winnerMessage.textContent = message;
                showScreen('gameOver');
            }
            
            // ==============================================
            // === ONLINE (FIRESTORE) GAME LOGIC ===========
            // ==============================================

            /**
             * Generates a unique 6-digit game ID
             */
             async function generateUniqueGameId() {
                let id = '';
                let isUnique = false;
                while (!isUnique) {
                    id = Math.floor(100000 + Math.random() * 900000).toString();
                    const gameRef = doc(db, `christmas_hazard_games`, id);
                    const gameDoc = await getDoc(gameRef);
                    if (!gameDoc.exists()) {
                        isUnique = true;
                    }
                }
                return id;
            }
            
            /**
             * Initializes Firebase and authenticates the user
             */
            async function initFirebase() {
                try {
                    app = globalApp;
                    db = getFirestore(app);
                    auth = getAuth(app);

                    return new Promise((resolve, reject) => {
                        const unsubscribe = onAuthStateChanged(auth, (user) => {
                            if (user) {
                                userId = user.uid;
                                console.log('Authenticated user:', userId);
                                unsubscribe(); // Stop listening
                                resolve(user);
                            } else {
                                // No user, try to sign in anonymously
                                signInAnonymously(auth)
                                    .then(() => {
                                        // The onAuthStateChanged listener will fire again with the new user
                                        // so we just wait.
                                    })
                                    .catch((authError) => {
                                        console.error('Error signing in anonymously:', authError);
                                        unsubscribe(); // Stop listening
                                        reject(authError);
                                    });
                            }
                        }, (error) => {
                            // Handle initial listener error
                            console.error('Auth state listener error:', error);
                            reject(error);
                        });
                    });
                } catch (e) {
                    console.error('Error initializing Firebase:', e);
                    loadingMessage.textContent = 'Error connecting to North Pole Network. Please refresh.';
                    return Promise.reject(e);
                }
            }


            /**
             * Host a new ONLINE game
             */
            async function hostGame() {
                showScreen('loading');
                loadingTitle.textContent = 'Creating Game...';
                loadingMessage.textContent = 'Setting up the sleigh...';
                
                try {
                    await initFirebase();
                    
                    gameId = await generateUniqueGameId(); // Generate 6-digit ID
                   // Use a simple root collection path
                   const gameRef = doc(db, `christmas_hazard_games`, gameId);
                    
                    // Create the initial ornament data
                    const initialOrnaments = [];
                    for (let i = 1; i <= TOTAL_ORNAMENTS; i++) {
                        initialOrnaments.push({ id: i, isRevealed: false, isPoison: false });
                    }
                    
                    const gameData = {
                        gameId: gameId,
                        player1: { uid: userId, name: 'Santa', poison: -1 },
                        player2: { uid: null, name: null, poison: -1 },
                        gameState: 'LOBBY', // LOBBY, P1_POISON, P2_POISON, P1_TURN, P2_TURN, GAME_OVER
                        currentPlayerUid: null,
                        ornaments: initialOrnaments,
                        winner: null,
                        message: `Waiting for Grinch to join...`,
                        createdAt: serverTimestamp()
                    };
                    
                    await setDoc(gameRef, gameData);
                    
                    // Show Game ID and wait
                    gameIdDisplay.textContent = gameId;
                    gameIdDisplayContainer.style.display = 'block';
                    loadingTitle.textContent = 'Waiting for Player 2';
                    loadingMessage.textContent = 'Share the Game ID with a friend.';
                    
                    // Listen for game updates (e.g., Player 2 joining)
                    listenToGameUpdates(gameId);
                    
                } catch (err) {
                    console.error('Error hosting game:', err);
                    loadingMessage.textContent = `Error: ${err.message}. Please try again.`;
                    setTimeout(fullReset, 3000);
                }
            }
            
            /**
             * Join an existing ONLINE game
             */
            async function joinGame() {
                const joinId = joinGameIdInput.value.trim();
                if (!joinId || joinId.length !== 6) {
                    alert('Please enter a valid 6-Digit Game ID.');
                    return;
                }
                
                showScreen('loading');
                loadingTitle.textContent = 'Joining Game...';
                loadingMessage.textContent = 'Finding the sleigh...';
                
                try {
                    await initFirebase();
                    
                    gameId = joinId;
                   const gameRef = doc(db, `christmas_hazard_games`, gameId);
                    
                    const gameDoc = await getDoc(gameRef);
                    if (!gameDoc.exists()) {
                        throw new Error('Game not found.');
                    }
                    
                    const gameData = gameDoc.data();
                    
                    if (gameData.player2.uid && gameData.player2.uid !== userId) {
                        throw new Error('This game is already full.');
                    }
                    
                    // Join as Player 2
                    await updateDoc(gameRef, {
                        'player2.uid': userId,
                        'player2.name': 'Grinch',
                        'gameState': 'P1_POISON', // Move to next state
                        'currentPlayerUid': gameData.player1.uid,
                        'message': `${gameData.player1.name}, pick a gift to fill with COAL.`
                    });
                    
                    // Successfully joined, start listening
                    listenToGameUpdates(gameId);
                    
                } catch (err) {
                    console.error('Error joining game:', err);
                    loadingMessage.textContent = `Error: ${err.message}. Please try again.`;
                    setTimeout(fullReset, 3000);
                }
            }
            
            /**
             * Main ONLINE game loop - listens to Firestore for changes
             */
            function listenToGameUpdates(gameIdToListen) {
               const gameRef = doc(db, `christmas_hazard_games`, gameIdToListen);
                
                localGameUnsubscribe = onSnapshot(gameRef, (doc) => {
                    if (!doc.exists()) {
                        // Don't alert if we're resetting
                        if (screens.modeSelect.classList.contains('active')) return;
                        alert('Game data not found! Returning to menu.');
                        fullReset();
                        return;
                    }
                    
                    const gameData = doc.data();
                    updateUiFromGameData(gameData);
                });
            }
            
            /**
             * Updates the entire UI based on the new gameData from Firestore
             */
            function updateUiFromGameData(gameData) {
                if (gameData.gameState === 'LOBBY') {
                    // Still on loading screen, waiting for P2
                    // We are already on the loading screen, just update text.
                    // DO NOT call showScreen('loading') again, as it detaches the listener.
                    loadingTitle.textContent = 'Waiting for Player 2';
                    loadingMessage.textContent = 'Share the Game ID with a friend.';
                    gameIdDisplay.textContent = gameData.gameId;
                    gameIdDisplayContainer.style.display = 'block';
                    return;
                }

                // If we're not in LOBBY, we should be on the game screen
                showScreen('game');
                
                // Update player names
                player1Status.textContent = gameData.player1.name || 'Santa';
                player2Status.textContent = gameData.player2.name || 'Grinch';
                
                // Update message box
                messageBox.textContent = gameData.message;
                
                // Check if it's our turn
                const isMyTurn = gameData.currentPlayerUid === userId;
                
                // Update turn indicator and status highlights
                if (gameData.gameState === 'P1_POISON' || gameData.gameState === 'P1_TURN') {
                    turnIndicator.textContent = `${gameData.player1.name}'s Turn`;
                    player1Status.classList.add('active');
                    player2Status.classList.remove('active');
                } else if (gameData.gameState === 'P2_POISON' || gameData.gameState === 'P2_TURN') {
                    turnIndicator.textContent = `${gameData.player2.name}'s Turn`;
                    player1Status.classList.remove('active');
                    player2Status.classList.add('active');
                } else {
                    turnIndicator.textContent = 'Game Over';
                    player1Status.classList.remove('active');
                    player2Status.classList.remove('active');
                }
                
                // Show "Waiting..." overlay if it's not our turn
                if (!isMyTurn && gameData.gameState !== 'GAME_OVER') {
                    messageBox.classList.add('online-wait');
                    messageBox.textContent = `Waiting for ${gameData.currentPlayerUid === gameData.player1.uid ? gameData.player1.name : gameData.player2.name} to move...`;
                    grid.classList.add('opponent-picking'); // ADDED: Start shiver animation
                } else {
                    messageBox.classList.remove('online-wait');
                    grid.classList.remove('opponent-picking'); // ADDED: Stop shiver animation
                }

                // Re-draw the ornament grid
                grid.innerHTML = '';
                gameData.ornaments.forEach(ornament => {
                    const el = createOrnamentElement(ornament.id, ornament.isRevealed, ornament.isPoison);
                    
                    // Add click listener for online mode
                    el.addEventListener('click', onOrnamentClick);
                    
                    // Disable clicking if it's not our turn, or if the game state is not a 'turn'
                    if (!isMyTurn || (gameData.gameState !== 'P1_POISON' && gameData.gameState !== 'P2_POISON' && gameData.gameState !== 'P1_TURN' && gameData.gameState !== 'P2_TURN')) {
                        el.classList.add('disabled');
                    }
                    
                    grid.appendChild(el);
                });
                
                // Check for Game Over
                if (gameData.gameState === 'GAME_OVER') {
                    endOnlineGame(gameData.message);
                }
            }
            
            /**
             * Handles a click on an ornament in ONLINE mode
             */
            async function handleOnlineOrnamentClick(ornamentId, gameData) {
                const isMyTurn = gameData.currentPlayerUid === userId;
                if (!isMyTurn) return; // Should be blocked by UI, but good to double-check
                
               const gameRef = doc(db, `christmas_hazard_games`, gameId);
                let update = {};

                try {
                    // --- Poison Selection Logic ---
                    if (gameData.gameState === 'P1_POISON') {
                        if (userId !== gameData.player1.uid) return;
                        
                        update = {
                            'player1.poison': ornamentId,
                            'gameState': 'P2_POISON',
                            'currentPlayerUid': gameData.player2.uid,
                            'message': `${gameData.player2.name}, pick YOUR gift to fill with COAL.`
                        };
                    } 
                    else if (gameData.gameState === 'P2_POISON') {
                        if (userId !== gameData.player2.uid) return;
                        
                        if (ornamentId === gameData.player1.poison) {
                            messageBox.textContent = `That gift is already full of... something. Pick another.`;
                            return; // Don't update, just show local message
                        }
                        
                        update = {
                            'player2.poison': ornamentId,
                            'gameState': 'P1_TURN',
                            'currentPlayerUid': gameData.player1.uid,
                            'message': `The unwrapping begins! ${gameData.player1.name}, pick a gift.`
                        };
                    }
                    
                    // --- Main Game Turn Logic ---
                    else if (gameData.gameState === 'P1_TURN' || gameData.gameState === 'P2_TURN') {
                        const ornament = gameData.ornaments.find(o => o.id === ornamentId);
                        if (ornament.isRevealed) {
                            messageBox.textContent = 'That gift is already open. Pick another.';
                            return; // Don't update
                        }
                        
                        // Mark the ornament as revealed
                        const newOrnaments = gameData.ornaments.map(o => 
                            o.id === ornamentId ? { ...o, isRevealed: true } : o
                        );
                        update.ornaments = newOrnaments;
                        
                        // Check for poison
                        const isPoison = (ornamentId === gameData.player1.poison || ornamentId === gameData.player2.poison);
                        
                        if (isPoison) {
                            // Mark as poison in the array for UI
                            update.ornaments = newOrnaments.map(o => 
                                o.id === ornamentId ? { ...o, isPoison: true } : o
                            );
                            
                            const loser = (gameData.gameState === 'P1_TURN') ? gameData.player1 : gameData.player2;
                            const winner = (gameData.gameState === 'P1_TURN') ? gameData.player2 : gameData.player1;
                            
                            update.gameState = 'GAME_OVER';
                            update.winner = winner.uid;
                            update.message = `OH NO! ${loser.name} found a lump of coal! ${winner.name} gets the sleigh!`;
                            update.currentPlayerUid = null;
                            
                        } else {
                            // It's safe, switch turns
                            const nextPlayer = (gameData.gameState === 'P1_TURN') ? gameData.player2 : gameData.player1;
                            update.gameState = (gameData.gameState === 'P1_TURN') ? 'P2_TURN' : 'P1_TURN';
                            update.currentPlayerUid = nextPlayer.uid;
                            update.message = `Safe! It's your turn, ${nextPlayer.name}.`;
                        }
                    }
                    
                    // Send the update to Firestore
                    await updateDoc(gameRef, update);

                } catch (err) {
                    console.error("Error updating game state:", err);
                    messageBox.textContent = "Error making move. Check console.";
                }
            }
            
            /**
             * Ends the ONLINE game and shows the Game Over screen
             */
            function endOnlineGame(message) {
                localGameUnsubscribe(); // Stop listening
                winnerMessage.textContent = message;
                showScreen('gameOver');
            }


            // ==============================================
            // === SHARED EVENT LISTENERS ===================
            // ==============================================

            /**
             * Main click handler for all ornaments.
             * Delegates to OFFLINE or ONLINE logic.
             */
            async function onOrnamentClick(e) {
                // Find the .ornament element, even if the click was on the emoji inside it
                const ornamentElement = e.target.closest('.ornament');
                if (!ornamentElement) return;

                const ornamentId = parseInt(ornamentElement.dataset.id);
                if (!ornamentId) return;
                
                if (isOnlineMode) {
                    // --- ONLINE LOGIC ---
                    // Fetch the *latest* game state to prevent race conditions
                   const gameRef = doc(db, `christmas_hazard_games`, gameId);
                    const gameDoc = await getDoc(gameRef);
                    if (gameDoc.exists()) {
                        handleOnlineOrnamentClick(ornamentId, gameDoc.data());
                    }
                } else {
                    // --- OFFLINE LOGIC ---
                    const ornamentData = local_ornaments.find(m => m.id === ornamentId);
                    
                    if (local_gameState === 'P1_POISON') {
                        local_player1Poison = ornamentId;
                        local_gameState = 'P2_POISON_WAIT';
                        messageBox.innerHTML = `Coal set! <br/> Pass the device to ${local_player2Name}. <br/> (Click this box when ready)`;
                        messageBox.classList.add('transition');
                        grid.classList.add('opponent-picking'); // Start shiver
                    }
                    else if (local_gameState === 'P2_POISON') {
                        if (ornamentId === local_player1Poison) {
                            messageBox.textContent = `That gift is already full of... something. Pick another, ${local_player2Name}.`;
                            return;
                        }
                        local_player2Poison = ornamentId;
                        local_gameState = 'START_TURN_WAIT';
                        messageBox.innerHTML = `All coal is set! <br/> Pass back to ${local_player1Name}. <br/> (Click this box to begin!)`;
                        messageBox.classList.add('transition');
                        grid.classList.add('opponent-picking'); // Start shiver
                    }
                    else if (local_gameState === 'P1_TURN' || local_gameState === 'P2_TURN') {
                        if (ornamentData.isRevealed) {
                            messageBox.textContent = 'That gift is already open. Pick another.';
                            return;
                        }
                        // Start "opponent picking" shiver for the other player
                        grid.classList.add('opponent-picking');
                        revealOfflineOrnament(ornamentId, ornamentData, ornamentElement);
                    }
                }
            }

            // --- Initial Setup & Mode Selection Listeners ---
            
            playOfflineBtn.addEventListener('click', () => {
                isOnlineMode = false;
                initOfflineGame();
            });
            
            playOnlineBtn.addEventListener('click', () => {
                isOnlineMode = true;
                showScreen('onlineSetup');
            });
            
            backToModeSelectBtn.addEventListener('click', () => {
                showScreen('modeSelect');
            });
            
            hostGameBtn.addEventListener('click', hostGame);
            joinGameBtn.addEventListener('click', joinGame);

            // Offline-only listeners
            startGameBtn.addEventListener('click', startOfflineGame);
            
            // Shared listeners
            playAgainBtn.addEventListener('click', fullReset);
            
            messageBox.addEventListener('click', () => {
                // Only handle transition clicks if in OFFLINE mode
                if (!isOnlineMode) {
                    handleOfflineTransitionClick();
                }
            });

            // --- Initial Kickoff ---
            createSnow();
            showScreen('modeSelect'); // Start at the mode select screen
        });
    </script>

</body>
</html>
