<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Christmas Hazard</title>
    
    <!-- 
      This game is a single, self-contained HTML file. 
      All CSS and JavaScript is inline.
      It supports both OFFLINE (hot-seat) and ONLINE (real-time) play.
    -->
    
    <style>
        /* --- Basic Setup & Theme --- */
        :root {
            --bg-night: #0c0f21;
            --bg-snow: #f1f5f9;
            --text-dark: #1e293b;
            --text-light: #e2e8f0;
            --festive-red: #dc2626;
            --festive-red-dark: #b91c1c;
            --festive-green: #166534;
            --festive-green-dark: #14532d;
            --gold: #f59e0b;
            --gold-dark: #d97706;
            --ice-blue: #7dd3fc;
            --ice-blue-dark: #0369a1;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(to bottom, var(--bg-night), #1a1d3a);
            color: var(--text-light);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 16px;
            overflow: hidden; /* Hides scrollbars from snow */
        }

        /* --- Animated Snow Background --- */
        #snow-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .flake {
            position: absolute;
            top: -10px;
            background: #fff;
            border-radius: 50%;
            opacity: 0.6;
            animation: fall linear infinite;
        }

        @keyframes fall {
            to {
                transform: translateY(105vh);
                opacity: 0;
            }
        }
        
        /* --- Titles & Text --- */
        h1, h2, h3 {
            font-family: 'Times New Roman', Times, serif;
            color: var(--text-dark);
            text-align: center;
            text-shadow: 1px 1px 1px #fff4;
        }
        
        h1 {
            font-size: 2.5rem;
            margin-bottom: 12px;
            color: var(--festive-red-dark);
        }
        
        h2 {
            font-size: 2rem;
            margin-bottom: 16px;
        }

        p {
            font-size: 1.1rem;
            line-height: 1.6;
            margin-bottom: 16px;
            text-align: center;
        }

        /* --- Game Container & Screens --- */
        #game-container {
            width: 100%;
            max-width: 900px;
            background: var(--bg-snow);
            color: var(--text-dark);
            border: 8px solid var(--festive-red-dark);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 10px 40px rgba(255, 255, 255, 0.2), 0 0 20px var(--gold);
            z-index: 1; /* Above the snow */
            transition: all 0.3s ease;
            position: relative; /* For snowman positioning */
            overflow: hidden; /* Keeps snowman contained */
        }

        .screen {
            display: none; /* Hidden by default */
        }

        .screen.active {
            display: block;
        }

        /* --- Snowman --- */
        #snowman {
            position: absolute;
            bottom: -10px;
            left: 10px;
            font-size: 4rem; /* Responsive */
            z-index: 10;
            transition: transform 0.3s ease;
            user-select: none;
            opacity: 0.9;
        }
        
        #snowman:hover {
            transform: scale(1.1) rotate(5deg);
        }

        
        /* --- Loading Spinner --- */
        .loader {
            width: 60px;
            height: 60px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid var(--festive-red);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .loading-text {
            text-align: center;
            font-size: 1.2rem;
            font-weight: bold;
        }

        /* --- Input & Buttons --- */
        .input-group {
            margin-bottom: 16px;
        }

        .input-group label {
            display: block;
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            font-size: 1.1rem;
            border: 2px solid #ccc;
            border-radius: 8px;
            background: #fff;
        }
        
        #game-id-display {
            background: #eee;
            border: 2px dashed var(--festive-red-dark);
            padding: 16px;
            font-size: 2rem; /* Bigger for 6 digits */
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            color: var(--text-dark);
            user-select: all;
            letter-spacing: 3px;
        }

        .game-button {
            display: block;
            width: 100%;
            padding: 16px;
            font-family: 'Times New Roman', Times, serif;
            font-size: 1.5rem;
            font-weight: bold;
            color: #fff;
            background: linear-gradient(to bottom, var(--festive-red), var(--festive-red-dark));
            border: none;
            border-bottom: 4px solid #7f1d1d;
            border-radius: 8px;
            cursor: pointer;
            text-shadow: 1px 1px 2px #000a;
            transition: all 0.2s ease;
            margin-top: 10px;
        }
        
        .game-button.secondary {
             background: linear-gradient(to bottom, var(--gold), var(--gold-dark));
             border-bottom-color: #a15c00;
        }
        
        .game-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }
        
        .game-button:active {
            transform: translateY(1px);
            border-bottom-width: 2px;
        }

        #play-again-btn {
            background: linear-gradient(to bottom, var(--festive-green), var(--festive-green-dark));
            border-bottom-color: #052e16;
        }

        /* --- Game Screen --- */
        #status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            background: #e0e6ec;
            border-radius: 8px;
            margin-bottom: 16px;
            border: 2px solid #cbd5e1;
        }
        
        .player-status {
            font-size: 1.2rem;
            font-weight: bold;
            padding: 8px 12px;
            border-radius: 6px;
            transition: all 0.3s ease;
        }
        
        .player-status.active {
            background-color: var(--gold);
            color: var(--text-dark);
            box-shadow: 0 0 10px var(--gold);
        }

        #turn-indicator {
            font-size: 1.5rem;
            font-weight: bold;
        }

        #message-box {
            font-size: 1.3rem;
            font-weight: bold;
            text-align: center;
            min-height: 50px;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 16px;
            background: #fff;
            border: 2px dashed #cbd5e1;
            border-radius: 8px;
            margin-bottom: 20px;
            line-height: 1.5;
        }
        
        /* This class is added when it's a "pass the device" screen */
        #message-box.transition {
            background: var(--text-dark);
            color: var(--text-light);
            cursor: pointer;
            min-height: 300px; /* Reduced height to fit globe */
            font-size: 2rem;
        }
        
        #message-box.online-wait {
            background: var(--text-dark);
            color: var(--text-light);
            min-height: 300px; /* Reduced height to fit globe */
            font-size: 2rem;
        }

        /* --- Gift Grid (Snowglobe) --- */
        #ornament-grid {
            /* This is now a flex container! */
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            gap: 16px;
            
            /* Snowglobe shape */
            max-width: 500px; /* Max size of globe */
            max-height: 500px;
            width: 100%;
            aspect-ratio: 1 / 1; /* Make it a square to be a circle */
            margin: 0 auto 20px auto;
            padding: 30px; /* Space from the edge */
            border: 4px solid var(--ice-blue-dark);
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%; /* The magic! */
            overflow: hidden; /* Clips children to the circle */
            
            visibility: visible;
            transition: visibility 0.2s;
        }
        
        #ornament-grid.hidden {
            visibility: hidden;
            height: 0;
            padding: 0;
            border: 0;
            overflow: hidden;
        }

        .ornament {
            /* Flex item size */
            flex: 0 0 70px;
            height: 70px;
            
            /* Icy crystal style */
            background: linear-gradient(135deg, rgba(255,255,255,0.4) 0%, rgba(255,255,255,0.1) 100%);
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 2.5rem; /* For emoji */
            display: flex;
            justify-content: center;
            align-items: center;
            user-select: none; /* Prevents text selection */
            text-shadow: 0 0 10px #fff;
            position: relative;
            overflow: hidden;
            color: var(--ice-blue-dark);
        }
        
        /* Sparkle/Glint effect */
        .ornament::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 20px;
            height: 200%;
            background: rgba(255,255,255,0.5);
            transform: rotate(30deg);
            opacity: 0;
            transition: opacity 0.4s ease;
        }
        
        .ornament:hover::before {
            opacity: 1;
            animation: glint 1.5s ease-in-out infinite;
        }

        @keyframes glint {
            0% { transform: rotate(30deg) translateX(-150px); }
            100% { transform: rotate(30deg) translateX(150px); }
        }
        
        
        .ornament:hover {
            transform: scale(1.1);
            box-shadow: 0 0 20px var(--gold), 0 0 30px #fff;
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* Ornament States */
        .ornament.revealed {
            background: #e0f2fe; /* Icy blue */
            border-color: #38bdf8;
            cursor: not-allowed;
            transform: scale(0.95);
            box-shadow: inset 0 0 10px #fff;
            color: var(--text-dark); /* Color for present */
        }
        
        .ornament.poison {
            background: #27272a !important; /* Coal black */
            border-color: #000 !important;
            color: #fff;
            animation: shake 0.5s ease-in-out;
        }
        
        .ornament.disabled {
            pointer-events: none;
            opacity: 0.7;
        }

        /* --- Animations --- */
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            20%, 60% { transform: translateX(-8px); }
            40%, 80% { transform: translateX(8px); }
        }

        /* --- Responsive Design --- */
        @media (max-width: 768px) {
            h1 { font-size: 2rem; }
            h2 { font-size: 1.8rem; }
            #status-bar { flex-direction: column; gap: 8px; }
            
            #snowman {
                font-size: 3rem;
                bottom: -5px;
                left: 5px;
            }
            
            /* Adjust flex item size for mobile */
            .ornament {
                flex: 0 0 50px;
                height: 50px;
                font-size: 1.8rem;
            }
            
            #ornament-grid {
                gap: 10px;
                padding: 15px;
            }
            
            #message-box.transition, #message-box.online-wait {
                min-height: 250px;
                font-size: 1.5rem;
            }
        }

        @media (max-width: 480px) {
             .ornament {
                flex: 0 0 40px;
                height: 40px;
                font-size: 1.5rem;
            }
            #ornament-grid {
                gap: 8px;
            }
        }
    </style>
</head>
<body>

    <div id="snow-container"></div>

    <div id="game-container">
        
        <div id="snowman">â›„</div>

        <!-- ===== MODE SELECT SCREEN ===== -->
        <div id="mode-select-screen" class="screen active">
            <h1>Christmas Hazard</h1>
            <h3 style="text-align: center; margin-bottom: 20px;">Santa vs. Grinch</h3>
            <p>How do you want to play?</p>
            <button id="play-offline-btn" class="game-button">Play Offline (Hot-Seat)</button>
            <button id="play-online-btn" class="game-button secondary">Play Online (2 Devices)</button>
        </div>
        
        <!-- ===== ONLINE SETUP SCREEN ===== -->
        <div id="online-setup-screen" class="screen">
            <h2>Play Online</h2>
            <button id="host-game-btn" class="game-button">Host New Game</button>
            <div class="input-group" style="margin-top: 20px;">
                <label for="join-game-id">Or Join Game:</label>
                <input type="text" id="join-game-id" placeholder="Enter 6-Digit ID" maxlength="6" pattern="\d*">
            </div>
            <button id="join-game-btn" class="game-button secondary">Join Game</button>
            <button id="back-to-mode-select-btn" class="game-button" style="background: #555; border-bottom-color: #333; margin-top: 20px;">Back</button>
        </div>
        
        <!-- ===== LOADING SCREEN ===== -->
        <div id="loading-screen" class="screen">
            <h2 id="loading-title">Loading...</h2>
            <div class="loader"></div>
            <p id="loading-message" class="loading-text">Connecting to the North Pole...</p>
            <div id="game-id-display-container" style="display: none;">
                <p>Tell your friend to join with this Game ID:</p>
                <div id="game-id-display">123456</div>
            </div>
        </div>

        <!-- ===== OFFLINE START SCREEN ===== -->
        <div id="start-screen" class="screen">
            <h1>Christmas Hazard</h1>
            <p>Santa's bag has 32 mysterious gifts. But beware! Each of you must secretly pick one gift to fill with COAL.</p>
            <p>Take turns picking gifts. If you pick one with coal, you're on stocking duty! Last one standing wins.</p>
            
            <div class="input-group">
                <label for="player1-name">Player 1 Name:</label>
                <input type="text" id="player1-name" placeholder="Santa" value="Santa">
            </div>
            <div class="input-group">
                <label for="player2-name">Player 2 Name:</label>
                <input type="text" id="player2-name" placeholder="Grinch" value="Grinch">
            </div>
            <button id="start-game-btn" class="game-button">Start the Gifting</button>
        </div>

        <!-- ===== GAME SCREEN ===== -->
        <div id="game-screen" class="screen">
            <div id="status-bar">
                <div id="player-1-status" class="player-status">Player 1</div>
                <div id="turn-indicator">Turn</div>
                <div id="player-2-status" class="player-status">Player 2</div>
            </div>
            
            <div id="message-box">
                Loading gifts...
            </div>
            
            <div id="ornament-grid">
                <!-- Gifts will be generated by JavaScript -->
            </div>
        </div>

        <!-- ===== GAME OVER SCREEN ===== -->
        <div id="game-over-screen" class="screen">
            <h2>Stocking Duty!</h2>
            <p id="winner-message">The winner is...</p>
            <button id="play-again-btn" class="game-button">Play Again</button>
        </div>

    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { 
            getAuth, 
            signInAnonymously, 
            signInWithCustomToken, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { 
            getFirestore, 
            doc, 
            getDoc, 
            setDoc, 
            updateDoc,
            onSnapshot,
            collection,
            serverTimestamp
        } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Your web app's Firebase configuration
        const firebaseConfig = {
          apiKey: "AIzaSyB36gEAQwwnDcLI2jONG3mZ-N9ndu-YmIE",
          authDomain: "four-in-a-row-watermelon.firebaseapp.com",
          databaseURL: "https://four-in-a-row-watermelon-default-rtdb.firebaseio.com",
          projectId: "four-in-a-row-watermelon",
          storageBucket: "four-in-a-row-watermelon.firebasestorage.app",
          messagingSenderId: "62983592186",
          appId: "1:62983592186:web:8c1886826e93e2ce9ed143",
          measurementId: "G-XF032WKJRC"
        };

        // Initialize Firebase
        const globalApp = initializeApp(firebaseConfig);
        // const analytics = getAnalytics(globalApp); // Analytics isn't used in this app

        document.addEventListener('DOMContentLoaded', () => {

            // --- Global State ---
            let isOnlineMode = false;
            let db, auth, app, userId, gameId;
            let localGameUnsubscribe = () => {}; // Function to stop listening to Firestore
            
            // --- Local (Offline) State Variables ---
            let local_player1Name = 'Player 1';
            let local_player2Name = 'Player 2';
            let local_player1Poison = -1;
            let local_player2Poison = -1;
            let local_currentPlayer = 1;
            let local_gameState = 'START'; // P1_POISON, P2_POISON_WAIT, P2_POISON, START_TURN_WAIT, P1_TURN, P2_TURN, GAME_OVER
            let local_ornaments = [];
            const TOTAL_ORNAMENTS = 32;

            // --- DOM Elements ---
            const screens = {
                modeSelect: document.getElementById('mode-select-screen'),
                onlineSetup: document.getElementById('online-setup-screen'),
                loading: document.getElementById('loading-screen'),
                start: document.getElementById('start-screen'),
                game: document.getElementById('game-screen'),
                gameOver: document.getElementById('game-over-screen')
            };
            
            const player1NameInput = document.getElementById('player1-name');
            const player2NameInput = document.getElementById('player2-name');
            const startGameBtn = document.getElementById('start-game-btn');
            
            const player1Status = document.getElementById('player-1-status');
            const player2Status = document.getElementById('player-2-status');
            const turnIndicator = document.getElementById('turn-indicator');
            const messageBox = document.getElementById('message-box');
            const grid = document.getElementById('ornament-grid');
            
            const winnerMessage = document.getElementById('winner-message');
            const playAgainBtn = document.getElementById('play-again-btn');
            
            const snowContainer = document.getElementById('snow-container');
            
            // Mode Select Buttons
            const playOfflineBtn = document.getElementById('play-offline-btn');
            const playOnlineBtn = document.getElementById('play-online-btn');
            
            // Online Setup Buttons & Inputs
            const hostGameBtn = document.getElementById('host-game-btn');
            const joinGameIdInput = document.getElementById('join-game-id');
            const joinGameBtn = document.getElementById('join-game-btn');
            const backToModeSelectBtn = document.getElementById('back-to-mode-select-btn');
            
            // Loading Screen Elements
            const loadingTitle = document.getElementById('loading-title');
            const loadingMessage = document.getElementById('loading-message');
            const gameIdDisplayContainer = document.getElementById('game-id-display-container');
            const gameIdDisplay = document.getElementById('game-id-display');

            // --- Utility Functions ---
            
            /**
             * Switches the active screen
             */
            function showScreen(screenName) {
                // Stop any existing game listeners if we're leaving the game screen
                if (isOnlineMode && screenName !== 'game' && screenName !== 'loading') { // Keep listener on loading screen!
                    localGameUnsubscribe();
                }
                
                Object.values(screens).forEach(screen => screen.classList.remove('active'));
                if (screens[screenName]) {
                    screens[screenName].classList.add('active');
                }
            }
            
            /**
             * Creates the falling snow effect
             */
            function createSnow() {
                // Only create snow once
                if (snowContainer.children.length > 0) return;
                
                const flakeCount = 100;
                for (let i = 0; i < flakeCount; i++) {
                    const flake = document.createElement('div');
                    flake.classList.add('flake');
                    
                    const size = Math.random() * 5 + 2; // 2px to 7px
                    flake.style.width = `${size}px`;
                    flake.style.height = `${size}px`;
                    flake.style.left = `${Math.random() * 100}vw`;
                    flake.style.opacity = Math.random() * 0.5 + 0.3; // 0.3 to 0.8
                    const duration = Math.random() * 10 + 10; // 10s to 20s
                    flake.style.animationDuration = `${duration}s`;
                    flake.style.animationDelay = `${Math.random() * -10}s`; // Start at random times
                    
                    const horizontalDrift = `translateX(${Math.random() * 100 - 50}px)`;
                    flake.animate([
                        { transform: `translateY(-10px) ${horizontalDrift}` },
                        { transform: `translateY(105vh) ${horizontalDrift}` }
                    ], {
                        duration: duration * 1000,
                        delay: Math.random() * -10000,
                        iterations: Infinity,
                        easing: 'linear'
                    });
                    snowContainer.appendChild(flake);
                }
            }
            
            /**
             * Resets the entire app to the mode select screen
             */
            function fullReset() {
                localGameUnsubscribe(); // Stop listening
                isOnlineMode = false;
                db = null;
                auth = null;
                app = null;
                userId = null;
                gameId = null;
                
                // Reset local game state just in case
                initOfflineGame(); 
                
                // Go back to the very first screen
                showScreen('modeSelect');
            }
            
            // ==============================================
            // === OFFLINE (HOT-SEAT) GAME LOGIC ===========
            // ==============================================

            /**
             * Resets the game to its initial state for OFFLINE play
             */
            function initOfflineGame() {
                local_player1Poison = -1;
                local_player2Poison = -1;
                local_currentPlayer = 1;
                local_gameState = 'START';
                local_ornaments = [];
                
                grid.innerHTML = '';
                player1NameInput.value = 'Santa';
                player2NameInput.value = 'Grinch';
                
                showScreen('start');
            }

            /**
             * Starts the OFFLINE game
             */
            function startOfflineGame() {
                local_player1Name = player1NameInput.value || 'Santa';
                local_player2Name = player2NameInput.value || 'Grinch';

                showScreen('game');
                
                generateOfflineOrnaments();
                setupOfflinePoisonPhase();
            }

            /**
             * Creates and displays all 32 ornament elements for OFFLINE play
             */
            function generateOfflineOrnaments() {
                grid.innerHTML = ''; 
                local_ornaments = []; 
                
                for (let i = 1; i <= TOTAL_ORNAMENTS; i++) {
                    const ornament = createOrnamentElement(i, false); // Not revealed
                    ornament.addEventListener('click', onOrnamentClick);
                    grid.appendChild(ornament);
                    local_ornaments.push({ id: i, isRevealed: false });
                }
            }
            
            /**
             * Creates a single ornament DOM element
             */
            function createOrnamentElement(id, isRevealed, isPoison = false) {
                 const ornament = document.createElement('div');
                ornament.classList.add('ornament');
                ornament.dataset.id = id;
                ornament.innerHTML = 'â„ï¸'; // Default snowflake
                
                if (isRevealed) {
                    ornament.classList.add('revealed');
                    if (isPoison) {
                        ornament.classList.add('poison');
                        ornament.innerHTML = 'âš«'; // Coal
                    } else {
                        ornament.innerHTML = 'ðŸŽ'; // Present
                    }
                }
                return ornament;
            }

            /**
             * Begins the poison selection phase for Player 1 (OFFLINE)
             */
            function setupOfflinePoisonPhase() {
                local_gameState = 'P1_POISON';
                messageBox.textContent = `${local_player1Name}, click a gift to fill with COAL. (Don't let ${local_player2Name} see!)`;
                messageBox.classList.remove('transition');
                grid.classList.remove('hidden');
                updateOfflinePlayerStatus();
                turnIndicator.textContent = 'Naughty Phase';
            }
            
            /**
             * Handles clicks on the message box during OFFLINE transition states
             */
            function handleOfflineTransitionClick() {
                if (local_gameState === 'P2_POISON_WAIT') {
                    local_gameState = 'P2_POISON';
                    messageBox.textContent = `${local_player2Name}, pick YOUR gift to fill with COAL. (Don't let ${local_player1Name} see!)`;
                    messageBox.classList.remove('transition');
                    grid.classList.remove('hidden');
                }
                else if (local_gameState === 'START_TURN_WAIT') {
                    local_gameState = 'P1_TURN';
                    local_currentPlayer = 1;
                    messageBox.textContent = `The unwrapping begins! ${local_player1Name}, pick a gift.`;
                    messageBox.classList.remove('transition');
                    grid.classList.remove('hidden');
                    updateOfflineTurnIndicator();
                }
            }

            /**
             * Reveals an ornament (OFFLINE)
             */
            function revealOfflineOrnament(id, data, element) {
                data.isRevealed = true;
                element.classList.add('revealed');
                
                const activePlayerName = (local_currentPlayer === 1) ? local_player1Name : local_player2Name;
                
                if (id === local_player1Poison || id === local_player2Poison) {
                    element.classList.add('poison');
                    element.innerHTML = 'âš«'; // Coal emoji
                    handleOfflinePoisonHit(activePlayerName);
                } else {
                    element.innerHTML = 'ðŸŽ'; // Present emoji
                    messageBox.textContent = 'Nice! Just a lovely gift...';
                    setTimeout(switchOfflineTurn, 1000); // Short delay
                }
            }
            
            /**
             * Handles logic when a poisoned ornament is hit (OFFLINE)
             */
            function handleOfflinePoisonHit(activePlayerName) {
                const winner = (local_currentPlayer === 1) ? local_player2Name : local_player1Name;
                messageBox.textContent = `OH NO! ${activePlayerName} found a lump of coal!`;
                
                setTimeout(() => {
                    endOfflineGame(`${activePlayerName} is on stocking duty! ${winner} gets the sleigh!`);
                }, 2000);
            }

            /**
             * Switches the turn to the other player (OFFLINE)
             */
            function switchOfflineTurn() {
                local_currentPlayer = (local_currentPlayer === 1) ? 2 : 1;
                local_gameState = (local_currentPlayer === 1) ? 'P1_TURN' : 'P2_TURN';
                updateOfflineTurnIndicator();
                messageBox.textContent = `It's your turn, ${local_currentPlayer === 1 ? local_player1Name : local_player2Name}.`;
            }
            
            /**
             * Updates the turn indicator (OFFLINE)
             */
            function updateOfflineTurnIndicator() {
                const activePlayerName = (local_currentPlayer === 1) ? local_player1Name : local_player2Name;
                turnIndicator.textContent = `${activePlayerName}'s Turn`;
                
                if (local_currentPlayer === 1) {
                    player1Status.classList.add('active');
                    player2Status.classList.remove('active');
                } else {
                    player1Status.classList.remove('active');
                    player2Status.classList.add('active');
                }
            }

            /**
             * Updates the player status bars (OFFLINE)
             */
            function updateOfflinePlayerStatus() {
                player1Status.innerHTML = `${local_player1Name}`;
                player2Status.innerHTML = `${local_player2Name}`;
            }

            /**
             * Ends the game (OFFLINE)
             */
            function endOfflineGame(message) {
                local_gameState = 'GAME_OVER';
                winnerMessage.textContent = message;
                showScreen('gameOver');
            }
            
            // ==============================================
            // === ONLINE (FIRESTORE) GAME LOGIC ===========
            // ==============================================

            /**
             * Generates a unique 6-digit game ID
             */
             async function generateUniqueGameId() {
                let id = '';
                let isUnique = false;
                while (!isUnique) {
                    id = Math.floor(100000 + Math.random() * 900000).toString();
                    const gameRef = doc(db, `christmas_hazard_games`, id);
                    const gameDoc = await getDoc(gameRef);
                    if (!gameDoc.exists()) {
                        isUnique = true;
                    }
                }
                return id;
            }
            
            /**
             * Initializes Firebase and authenticates the user
             */
            async function initFirebase() {
                try {
                    app = globalApp;
                    db = getFirestore(app);
                    auth = getAuth(app);

                    return new Promise((resolve, reject) => {
                        const unsubscribe = onAuthStateChanged(auth, (user) => {
                            if (user) {
                                userId = user.uid;
                                console.log('Authenticated user:', userId);
                                unsubscribe(); // Stop listening
                                resolve(user);
                            } else {
                                // No user, try to sign in anonymously
                                signInAnonymously(auth)
                                    .then(() => {
                                        // The onAuthStateChanged listener will fire again with the new user
                                        // so we just wait.
                                    })
                                    .catch((authError) => {
                                        console.error('Error signing in anonymously:', authError);
                                        unsubscribe(); // Stop listening
                                        reject(authError);
                                    });
                            }
                        }, (error) => {
                            // Handle initial listener error
                            console.error('Auth state listener error:', error);
                            reject(error);
                        });
                    });
                } catch (e) {
                    console.error('Error initializing Firebase:', e);
                    loadingMessage.textContent = 'Error connecting to North Pole Network. Please refresh.';
                    return Promise.reject(e);
                }
            }


            /**
             * Host a new ONLINE game
             */
            async function hostGame() {
                showScreen('loading');
                loadingTitle.textContent = 'Creating Game...';
                loadingMessage.textContent = 'Setting up the sleigh...';
                
                try {
                    await initFirebase();
                    
                    gameId = await generateUniqueGameId(); // Generate 6-digit ID
                   // Use a simple root collection path
                   const gameRef = doc(db, `christmas_hazard_games`, gameId);
                    
                    // Create the initial ornament data
                    const initialOrnaments = [];
                    for (let i = 1; i <= TOTAL_ORNAMENTS; i++) {
                        initialOrnaments.push({ id: i, isRevealed: false, isPoison: false });
                    }
                    
                    const gameData = {
                        gameId: gameId,
                        player1: { uid: userId, name: 'Santa', poison: -1 },
                        player2: { uid: null, name: null, poison: -1 },
                        gameState: 'LOBBY', // LOBBY, P1_POISON, P2_POISON, P1_TURN, P2_TURN, GAME_OVER
                        currentPlayerUid: null,
                        ornaments: initialOrnaments,
                        winner: null,
                        message: `Waiting for Grinch to join...`,
                        createdAt: serverTimestamp()
                    };
                    
                    await setDoc(gameRef, gameData);
                    
                    // Show Game ID and wait
                    gameIdDisplay.textContent = gameId;
                    gameIdDisplayContainer.style.display = 'block';
                    loadingTitle.textContent = 'Waiting for Player 2';
                    loadingMessage.textContent = 'Share the Game ID with a friend.';
                    
                    // Listen for game updates (e.g., Player 2 joining)
                    listenToGameUpdates(gameId);
                    
                } catch (err) {
                    console.error('Error hosting game:', err);
                    loadingMessage.textContent = `Error: ${err.message}. Please try again.`;
                    setTimeout(fullReset, 3000);
                }
            }
            
            /**
             * Join an existing ONLINE game
             */
            async function joinGame() {
                const joinId = joinGameIdInput.value.trim();
                if (!joinId || joinId.length !== 6) {
                    alert('Please enter a valid 6-Digit Game ID.');
                    return;
                }
                
                showScreen('loading');
                loadingTitle.textContent = 'Joining Game...';
                loadingMessage.textContent = 'Finding the sleigh...';
                
                try {
                    await initFirebase();
                    
                    gameId = joinId;
                   const gameRef = doc(db, `christmas_hazard_games`, gameId);
                    
                    const gameDoc = await getDoc(gameRef);
                    if (!gameDoc.exists()) {
                        throw new Error('Game not found.');
                    }
                    
                    const gameData = gameDoc.data();
                    
                    if (gameData.player2.uid) {
                        throw new Error('This game is already full.');
                    }
                    
                    // Join as Player 2
                    await updateDoc(gameRef, {
                        'player2.uid': userId,
                        'player2.name': 'Grinch',
                        'gameState': 'P1_POISON', // Move to next state
                        'currentPlayerUid': gameData.player1.uid,
                        'message': `${gameData.player1.name}, pick a gift to fill with COAL.`
                    });
                    
                    // Successfully joined, start listening
                    listenToGameUpdates(gameId);
                    
                } catch (err) {
                    console.error('Error joining game:', err);
                    loadingMessage.textContent = `Error: ${err.message}. Please try again.`;
                    setTimeout(fullReset, 3000);
                }
            }
            
            /**
             * Main ONLINE game loop - listens to Firestore for changes
             */
            function listenToGameUpdates(gameIdToListen) {
               const gameRef = doc(db, `christmas_hazard_games`, gameIdToListen);
                
                localGameUnsubscribe = onSnapshot(gameRef, (doc) => {
                    if (!doc.exists()) {
                        alert('Game data not found! Returning to menu.');
                        fullReset();
                        return;
                    }
                    
                    const gameData = doc.data();
                    updateUiFromGameData(gameData);
                });
            }
            
            /**
             * Updates the entire UI based on the new gameData from Firestore
             */
            function updateUiFromGameData(gameData) {
                if (gameData.gameState === 'LOBBY') {
                    // Still on loading screen, waiting for P2
                    // We are already on the loading screen, just update text.
                    // DO NOT call showScreen('loading') again, as it detaches the listener.
                    loadingTitle.textContent = 'Waiting for Player 2';
                    loadingMessage.textContent = 'Share the Game ID with a friend.';
                    gameIdDisplay.textContent = gameData.gameId;
                    gameIdDisplayContainer.style.display = 'block';
                    return;
                }

                // If we're not in LOBBY, we should be on the game screen
                showScreen('game');
                
                // Update player names
                player1Status.textContent = gameData.player1.name || 'Santa';
                player2Status.textContent = gameData.player2.name || 'Grinch';
                
                // Update message box
                messageBox.textContent = gameData.message;
                
                // Check if it's our turn
                const isMyTurn = gameData.currentPlayerUid === userId;
                
                // Update turn indicator and status highlights
                if (gameData.gameState === 'P1_POISON' || gameData.gameState === 'P1_TURN') {
                    turnIndicator.textContent = `${gameData.player1.name}'s Turn`;
                    player1Status.classList.add('active');
                    player2Status.classList.remove('active');
                } else if (gameData.gameState === 'P2_POISON' || gameData.gameState === 'P2_TURN') {
                    turnIndicator.textContent = `${gameData.player2.name}'s Turn`;
                    player1Status.classList.remove('active');
                    player2Status.classList.add('active');
                } else {
                    turnIndicator.textContent = 'Game Over';
                    player1Status.classList.remove('active');
                    player2Status.classList.remove('active');
                }
                
                // Show "Waiting..." overlay if it's not our turn
                if (!isMyTurn && gameData.gameState !== 'GAME_OVER') {
                    messageBox.classList.add('online-wait');
                    messageBox.textContent = `Waiting for ${gameData.currentPlayerUid === gameData.player1.uid ? gameData.player1.name : gameData.player2.name} to move...`;
                    grid.classList.add('hidden');
                } else {
                    messageBox.classList.remove('online-wait');
                    grid.classList.remove('hidden');
                }

                // Re-draw the ornament grid
                grid.innerHTML = '';
                gameData.ornaments.forEach(ornament => {
                    const el = createOrnamentElement(ornament.id, ornament.isRevealed, ornament.isPoison);
                    
                    // Add click listener for online mode
                    el.addEventListener('click', onOrnamentClick);
                    
                    // Disable clicking if it's not our turn, or if the game state is not a 'turn'
                    if (!isMyTurn || (gameData.gameState !== 'P1_POISON' && gameData.gameState !== 'P2_POISON' && gameData.gameState !== 'P1_TURN' && gameData.gameState !== 'P2_TURN')) {
                        el.classList.add('disabled');
                    }
                    
                    grid.appendChild(el);
                });
                
                // Check for Game Over
                if (gameData.gameState === 'GAME_OVER') {
                    endOnlineGame(gameData.message);
                }
            }
            
            /**
             * Handles a click on an ornament in ONLINE mode
             */
            async function handleOnlineOrnamentClick(ornamentId, gameData) {
                const isMyTurn = gameData.currentPlayerUid === userId;
                if (!isMyTurn) return; // Should be blocked by UI, but good to double-check
                
               const gameRef = doc(db, `christmas_hazard_games`, gameId);
                let update = {};

                try {
                    // --- Poison Selection Logic ---
                    if (gameData.gameState === 'P1_POISON') {
                        if (userId !== gameData.player1.uid) return;
                        
                        update = {
                            'player1.poison': ornamentId,
                            'gameState': 'P2_POISON',
                            'currentPlayerUid': gameData.player2.uid,
                            'message': `${gameData.player2.name}, pick YOUR gift to fill with COAL.`
                        };
                    } 
                    else if (gameData.gameState === 'P2_POISON') {
                        if (userId !== gameData.player2.uid) return;
                        
                        if (ornamentId === gameData.player1.poison) {
                            messageBox.textContent = `That gift is already full of... something. Pick another.`;
                            return; // Don't update, just show local message
                        }
                        
                        update = {
                            'player2.poison': ornamentId,
                            'gameState': 'P1_TURN',
                            'currentPlayerUid': gameData.player1.uid,
                            'message': `The unwrapping begins! ${gameData.player1.name}, pick a gift.`
                        };
                    }
                    
                    // --- Main Game Turn Logic ---
                    else if (gameData.gameState === 'P1_TURN' || gameData.gameState === 'P2_TURN') {
                        const ornament = gameData.ornaments.find(o => o.id === ornamentId);
                        if (ornament.isRevealed) {
                            messageBox.textContent = 'That gift is already open. Pick another.';
                            return; // Don't update
                        }
                        
                        // Mark the ornament as revealed
                        const newOrnaments = gameData.ornaments.map(o => 
                            o.id === ornamentId ? { ...o, isRevealed: true } : o
                        );
                        update.ornaments = newOrnaments;
                        
                        // Check for poison
                        const isPoison = (ornamentId === gameData.player1.poison || ornamentId === gameData.player2.poison);
                        
                        if (isPoison) {
                            // Mark as poison in the array for UI
                            update.ornaments = newOrnaments.map(o => 
                                o.id === ornamentId ? { ...o, isPoison: true } : o
                            );
                            
                            const loser = (gameData.gameState === 'P1_TURN') ? gameData.player1 : gameData.player2;
                            const winner = (gameData.gameState === 'P1_TURN') ? gameData.player2 : gameData.player1;
                            
                            update.gameState = 'GAME_OVER';
                            update.winner = winner.uid;
                            update.message = `OH NO! ${loser.name} found a lump of coal! ${winner.name} gets the sleigh!`;
                            update.currentPlayerUid = null;
                            
                        } else {
                            // It's safe, switch turns
                            const nextPlayer = (gameData.gameState === 'P1_TURN') ? gameData.player2 : gameData.player1;
                            update.gameState = (gameData.gameState === 'P1_TURN') ? 'P2_TURN' : 'P1_TURN';
                            update.currentPlayerUid = nextPlayer.uid;
                            update.message = `Safe! It's your turn, ${nextPlayer.name}.`;
                        }
                    }
                    
                    // Send the update to Firestore
                    await updateDoc(gameRef, update);

                } catch (err) {
                    console.error("Error updating game state:", err);
                    messageBox.textContent = "Error making move. Check console.";
                }
            }
            
            /**
             * Ends the ONLINE game and shows the Game Over screen
             */
            function endOnlineGame(message) {
                localGameUnsubscribe(); // Stop listening
                winnerMessage.textContent = message;
                showScreen('gameOver');
            }


            // ==============================================
            // === SHARED EVENT LISTENERS ===================
            // ==============================================

            /**
             * Main click handler for all ornaments.
             * Delegates to OFFLINE or ONLINE logic.
             */
            async function onOrnamentClick(e) {
                // Find the .ornament element, even if the click was on the emoji inside it
                const ornamentElement = e.target.closest('.ornament');
                if (!ornamentElement) return;

                const ornamentId = parseInt(ornamentElement.dataset.id);
                if (!ornamentId) return;
                
                if (isOnlineMode) {
                    // --- ONLINE LOGIC ---
                    // Fetch the *latest* game state to prevent race conditions
                   const gameRef = doc(db, `christmas_hazard_games`, gameId);
                    const gameDoc = await getDoc(gameRef);
                    if (gameDoc.exists()) {
                        handleOnlineOrnamentClick(ornamentId, gameDoc.data());
                    }
                } else {
                    // --- OFFLINE LOGIC ---
                    const ornamentData = local_ornaments.find(m => m.id === ornamentId);
                    
                    if (local_gameState === 'P1_POISON') {
                        local_player1Poison = ornamentId;
                        local_gameState = 'P2_POISON_WAIT';
                        messageBox.innerHTML = `Coal set! <br/> Pass the device to ${local_player2Name}. <br/> (Click this box when ready)`;
                        messageBox.classList.add('transition');
                        grid.classList.add('hidden');
                    }
                    else if (local_gameState === 'P2_POISON') {
                        if (ornamentId === local_player1Poison) {
                            messageBox.textContent = `That gift is already full of... something. Pick another, ${local_player2Name}.`;
                            return;
                        }
                        local_player2Poison = ornamentId;
                        local_gameState = 'START_TURN_WAIT';
                        messageBox.innerHTML = `All coal is set! <br/> Pass back to ${local_player1Name}. <br/> (Click this box to begin!)`;
                        messageBox.classList.add('transition');
                        grid.classList.add('hidden');
                    }
                    else if (local_gameState === 'P1_TURN' || local_gameState === 'P2_TURN') {
                        if (ornamentData.isRevealed) {
                            messageBox.textContent = 'That gift is already open. Pick another.';
                            return;
                        }
                        revealOfflineOrnament(ornamentId, ornamentData, ornamentElement);
                    }
                }
            }

            // --- Initial Setup & Mode Selection Listeners ---
            
            playOfflineBtn.addEventListener('click', () => {
                isOnlineMode = false;
                initOfflineGame();
            });
            
            playOnlineBtn.addEventListener('click', () => {
                isOnlineMode = true;
                showScreen('onlineSetup');
            });
            
            backToModeSelectBtn.addEventListener('click', () => {
                showScreen('modeSelect');
            });
            
            hostGameBtn.addEventListener('click', hostGame);
            joinGameBtn.addEventListener('click', joinGame);

            // Offline-only listeners
            startGameBtn.addEventListener('click', startOfflineGame);
            
            // Shared listeners
            playAgainBtn.addEventListener('click', fullReset);
            
            messageBox.addEventListener('click', () => {
                // Only handle transition clicks if in OFFLINE mode
                if (!isOnlineMode) {
                    handleOfflineTransitionClick();
                }
            });

            // --- Initial Kickoff ---
            createSnow();
            showScreen('modeSelect'); // Start at the mode select screen
        });
    </script>

</body>
</html>
